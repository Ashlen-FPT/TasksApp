@model IEnumerable<TasksApp.Models.DailyWeigh>

@{
    ViewData["Title"] = "Index";
}

<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<link href="~/plugins/fontawesome-free/css/all.css" rel="stylesheet" />

<h4>DAILY WEIGHBRIDGE TEST</h4>

<div class="form-group">
    <label class="control-label">Choose date</label>
    <input class="form-control" id="datePicker" type="date" value="@DateTime.Now.Date.ToString("yyyy-MM-dd")" max="@DateTime.Now.Date.ToString("yyyy-MM-dd")" />

</div>

<br />

<table class="center table table-striped table-bordered table-hover" id="tbl" style=" word-wrap:break-word; width:40%; table-layout:fixed">
    <thead class="thead-dark">
        <tr>
            <th> @Html.DisplayNameFor(model => model.Date) </th>

            <td>
                @foreach (var item in Model)
                {
                    @Html.DisplayFor(modelItem => item.Date)
                }
            </td>
        </tr>

        <tr>
            <th> @Html.DisplayNameFor(model => model.Time) </th>

            <td>
                @foreach (var item in Model)
                {
                    @Html.DisplayFor(modelItem => item.Time)
                }
            </td>
        </tr>

        <tr>
            <th> @Html.DisplayNameFor(model => model.Supervisor) </th>

            <td>
                @foreach (var item in Model)
                {
                    @Html.DisplayFor(modelItem => item.Supervisor)
                }
            </td>
        </tr>
    </thead>
</table>

<br />

<p><b>Readings should always show 0.0g</b></p>

<br />

<table class="center table table-striped table-bordered table-hover" id="tbl1" style=" word-wrap:break-word; width:60%; table-layout:fixed">
    <thead class="thead-dark">
        <tr class="table-info">
            <th style="width:10%">
                @Html.DisplayNameFor(model => model.Gross)
            </th>
            <th style="width:10%">
                @Html.DisplayNameFor(model => model.Tare)
            </th>
            <th style="width:10%">
                @Html.DisplayNameFor(model => model.Net)
            </th>
            <th style="width:50%">
                @Html.DisplayNameFor(model => model.Observation)
            </th>
        </tr>
    </thead>

    <tbody>
        <tr>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="text" style="width:90%" /></td>
        </tr>

        <tr>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="text" style="width:90%" /></td>
        </tr>

        <tr>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="text" style="width:90%" /></td>
        </tr>

        <tr>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="number" style="width:90%" /></td>
            <td> <input type="text" style="width:90%" /></td>
        </tr>
    </tbody>
</table>


<div class="card text-center" style="width: 100%;">
    <div class="card-body">
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-homes" role="tabpanel" aria-labelledby="pills-homes-tab">

                <div class="progress">
                    <div class="progress-bar" id="progressbar" role="progressbar" style="width: 1%" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <br />

                <table id="Table01" class="table table-striped table-bordered table-hover" style=" word-wrap:break-word; width:100%; table-layout:fixed">
                    <thead class="thead-dark">
                        <tr class="table-info">
                            <th>Description</th>
                            <th>IsDone</th>
                            <th>Date Task Completed</th>
                            <th>Add Comments</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add Comment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form>

                    <div class="form-group">
                        <label for="message-text" class="col-form-label">Comments:</label>
                        <textarea class="form-control" id="message-text"></textarea>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" onclick="SaveComment()" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
<br />

<html>
<head>
    <style>
        p {
            text-align: center;
        }

        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

            table.center {
                margin-left: auto;
                margin-right: auto;
            }
    </style>
</head>
<body>

</body>
</html>

<script src="~/plugins/jquery/jquery.js"></script>
<link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.11.5/datatables.min.js"></script>

<script>

    $(document).ready(function () {
        var date = document.getElementById("datePicker").value;
        loadTable(date);

        $.ajax({
            type: "GET",
            dataType: 'json',
            url: "/DailyWeighs/GetAll?date=" + date,
            async: false,
            success: function (response) {
                var count = 0;

                for (var i = 0; i < response.data.length; i++) {

                    if (response.data[i].isDone == true) {
                        count += 1;
                    }

                }

                var p = (count / response.data.length) * 100;
                if (p == 0) {
                    document.getElementById("progressbar").style.width = "0%";
                    document.getElementById("progressbar").innerHTML = "0%";
                }
                else {
                    document.getElementById("progressbar").style.width = p + "%";
                    document.getElementById("progressbar").innerHTML = Math.round(p) + "%";
                }
            }
        });
    });


    //$('#datePicker').change(function () {
    //    var date = document.getElementById("datePicker").value;
    //    Table01.destroy();
    //    loadTable(date);


    //    $.ajax({
    //        type: "GET",
    //        dataType: 'json',
    //        url: "/DailyWeighs/GetAllAsync?date=" + date,
    //        async: false,
    //        success: function (response) {

    //            var count = 0;

    //            for (var i = 0; i < response.data.length; i++) {

    //                if (response.data[i].isDone == true) {
    //                    count += 1;
    //                }

    //            }

    //            var p = (count / response.data.length) * 100;

    //            if (Number.isNaN(p)) {
    //                console.log(p)
    //                document.getElementById("progressbar").style.width = "0%";
    //                document.getElementById("progressbar").innerHTML = "0%";
    //            }
    //            else if (p == 0) {
    //                document.getElementById("progressbar").style.width = "0%";
    //                document.getElementById("progressbar").innerHTML = "0%";
    //            }

    //            else {
    //                document.getElementById("progressbar").style.width = p + "%";
    //                document.getElementById("progressbar").innerHTML = Math.round(p) + "%";
    //            }

    //        }
    //    });

    //});

    function loadTable(date) {

        //Table01 = $("#tbl").DataTable({
        //    "ajax": {
        //        "url": "/DailyWeighs/AddTask",
        //    },
        //    responsive: true,
        //    autoWidth: false,
        //    "columns": [
        //        { "data": "date", "width": "20%" },
        //        { "data": "time", "width": "20%" },
        //        { "data": "Username", "width": "20%" },

        //    ]
        //});

        Table01 = $("#Table01").DataTable({
            "ajax": {
                "url": "/DailyWeighs/GetTasksToday?date=" + date
            },
            "columns": [
                { "data": "description", "width": "60%" },
                {
                    "data": {
                        id: "id", isDone: "isDone"
                    },
                    "render": function (data) {
                        if (data.isDone == true) {

                            return `
                                <div class="text-center">
                                   <input disabled type="checkbox" checked="true" />

                                </div>
                               `;

                        }

                        if (data.isDone == false) {

                            return `
                                <div class="text-center">
                                   <input onclick=Delete("Tasks/CompleteTask/${data.id}") type="checkbox" />

                                </div>
                               `;

                        }

                    }, "width": "30%"
                },
                {
                    "data": "dateTaskCompleted",
                    'render': function (jsonDate) {

                        if (jsonDate == "0001-01-01T00:00:00") {
                            return " ";
                        }
                        else {
                            var datestr = jsonDate.toString();
                            var date = new Date(datestr.substr(0, 10));
                            var month = ("0" + (date.getMonth() + 1)).slice(-2);
                            var time = datestr.substr(11)
                            var hr = time.substr(0, 2)
                            var min = time.substr(3, 2)
                            var sec = time.substr(6, 2);
                            return ("0" + date.getDate()).slice(-2) + '-' + month + '-' + date.getFullYear() + "  " + hr + ":" + min + ":" + sec;
                        }

                    }, "width": "50%"
                },

                {
                    "data": {
                        id: "id"
                    },
                    "render": function (data) {


                        return `
                                <div class="text-center">
                                   <button type="button" class="btn btn-info" onclick="showModal(this)"  data-id="${data.id}" >
                                        <i class="fas fa-comment"></i>
                                    </button>

                                </div>
                               `;
                    }, "width": "40%"
                },

                { "data": "comments", "width": "100%" },

                {
                    "data": {
                        id: "id"
                    },
                    "render": function (data) {

                        return `
                                <a href="DailyWeighs/Index" data-id="${data.id}">View Detailed</a>
                               `;
                    }, "width": "40%"
                }

            ]
        });

        Table02 = $("#tbl1")({
            "ajax": {
                "url": "/DailyWeighs/AddTask",
            },
            responsive: true,
            autoWidth: false,
            "columns": [
                {
                    orderable: false,
                    targets: [1],
                },
                { "data": "gross", "width": "20%" },
                { "data": "tare", "width": "20%" },
                { "data": "net", "width": "20%" },
                { "data": "observation", "width": "40%" },

            ]
        });

        $('button').click(function () {
            var data = table.$('input, select').serialize();
            alert('The following data would have been submitted to the server: \n\n' + data.substr(0, 120) + '...');
            return false;
        });
    }

    var CommentId = 1;

    function showModal(event) {
        $('#exampleModal').modal("toggle");
        CommentId = event.dataset.id

        $.ajax({
            type: "GET",
            dataType: 'json',
            url: "/DailyWeighs/GetTask?id=" + CommentId,
            async: false,
            success: function (response) {
                document.getElementById("message-text").value = response.comments;
                console.log(response.comments)
            }
        });
    }

    function SaveComment() {

        console.log("save")
        var comment = document.getElementById("message-text").value;
        $.ajax({

            type: "GET",
            dataType: 'json',
            url: "/DailyWeighs/AddComment?id=" + CommentId + "&comment=" + comment,
            async: false,
            success: function (response) {
                toastr.success(response.message);
                Table01.ajax.reload();
            }
        });

        $('#exampleModal').modal("toggle");
    }
</script>
